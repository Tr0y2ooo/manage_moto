<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ğŸï¸ æ©Ÿè»Šåº«å­˜ç®¡ç†ç³»çµ±</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

  <style>
    body { margin:0; font-family:"Noto Sans TC",sans-serif; background:#121212; color:#f0f0f0;}
    header { background:linear-gradient(90deg,#1f1f1f,#2c2c2c); color:#80e27e; text-align:center; padding:16px 0; font-size:1.8rem; font-weight:bold; letter-spacing:1px; box-shadow:0 2px 10px rgba(0,0,0,0.3);}
    main { display:flex; flex-wrap:wrap; justify-content:center; gap:24px; padding:30px; max-width:1300px; margin:auto;}
    #loginContainer, #formContainer { background:#1e1e1e; border-radius:12px; padding:24px; width:380px; box-shadow:0 0 12px rgba(0,0,0,0.4);}
    h2 { color:#a5d6a7; border-left:4px solid #81c784; padding-left:8px;}
    label { display:block; margin-top:12px; font-weight:600;}
    input, textarea, select, button { width:100%; padding:8px; margin-top:6px; border:none; border-radius:6px; font-size:0.95rem; outline:none;}
    input, textarea, select { background:#2a2a2a; color:#eee;}
    input:focus, textarea:focus, select:focus { background:#333; border:1px solid #81c784;}
    button { cursor:pointer; margin-top:16px; transition:0.2s;}
    button:hover { transform:scale(1.03);}
    #bikeGrid { flex:1; min-width:650px; display:flex; flex-wrap:wrap; gap:20px; justify-content:center;}
    .bike-card { background:#1f1f1f; border-radius:12px; padding:16px; width:300px; box-shadow:0 0 10px rgba(0,0,0,0.4); transition: transform 0.2s ease, box-shadow 0.2s ease;}
    .bike-card:hover { transform:translateY(-4px); box-shadow:0 0 18px rgba(129,199,132,0.3);}
    .image-slider { display:flex; overflow-x:auto; gap:8px; margin-bottom:8px;}
    .image-slider img { height:140px; border-radius:8px; flex-shrink:0;}
    .status-badge { padding:4px 10px; border-radius:12px; font-weight:bold; font-size:0.85rem; }
    .status-badge.è²©å”®ä¸­{background:#2e7d32;color:#fff;}
    .status-badge.å·²å”®å‡º{background:#c62828;color:#fff;}
    .status-badge.æš«å”®{background:#ffb300;color:#000;}
    .status-badge.ç¶­ä¿®ä¸­{background:#1565c0;color:#fff;}
  </style>
</head>
<body>
  <header>ğŸï¸ æ©Ÿè»Šåº«å­˜ç®¡ç†ç³»çµ±</header>
  <main>
    <!-- ç™»å…¥å€ -->
    <div id="loginContainer">
      <h2>ä½¿ç”¨è€…ç™»å…¥</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="å¯†ç¢¼">
      <button id="loginBtn">ç™»å…¥</button>
      <p id="loginStatus"></p>
      <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
    </div>

    <!-- æ©Ÿè»Šè³‡æ–™è¡¨å–® -->
    <div id="formContainer" style="display:none;">
      <h2>æ–°å¢æ©Ÿè»Šè³‡æ–™</h2>
      <form id="bikeForm">
        <label>æ©Ÿè»Šåœ–ç‰‡:</label>
        <input type="file" id="imageFile" accept="image/*" multiple required>
        <label>è»Šç¨®åç¨±:</label>
        <input type="text" id="model" required>
        <label>å¹´ä»½:</label>
        <input type="number" id="year" min="1900" max="2100" required>
        <label>é‡Œç¨‹:</label>
        <input type="number" id="mileage" min="0" required>
        <label>è»Šæ³:</label>
        <input type="text" id="condition" required>
        <label>å‚™è¨»:</label>
        <textarea id="note" rows="3"></textarea>
        <label>å³æ™‚ç‹€æ…‹:</label>
        <select id="status" required>
          <option value="è²©å”®ä¸­">è²©å”®ä¸­</option>
          <option value="å·²å”®å‡º">å·²å”®å‡º</option>
          <option value="æš«å”®">æš«å”®</option>
          <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
        </select>
        <button type="submit">ä¸Šå‚³</button>
      </form>
      <p id="status"></p>
    </div>

    <!-- æ©Ÿè»Šæ¸…å–® -->
    <div id="bikeGrid"></div>
  </main>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDNeIDnfVZpb_lF_2RPBNDaP91nMC1JeWI",
    authDomain: "bike-c4e9d.firebaseapp.com",
    projectId: "bike-c4e9d",
    storageBucket: "bike-c4e9d.firebasestorage.app",
    messagingSenderId: "239868665129",
    appId: "1:239868665129:web:0f80ce710a268bfde1eb38"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const firestore = firebase.firestore();
  const storage = firebase.storage();

  const loginContainer = document.getElementById('loginContainer');
  const loginStatus = document.getElementById('loginStatus');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const formContainer = document.getElementById('formContainer');
  const form = document.getElementById('bikeForm');
  const statusText = document.getElementById('status');
  const bikeGrid = document.getElementById('bikeGrid');

  let currentUser = null;

  // ç›£è½ç™»å…¥ç‹€æ…‹
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      loginContainer.style.display = 'none';
      formContainer.style.display = 'block';
      logoutBtn.style.display = 'block';
      loadBikes();
    } else {
      loginContainer.style.display = 'block';
      formContainer.style.display = 'none';
      logoutBtn.style.display = 'none';
      bikeGrid.innerHTML = '';
    }
  });

  // ç™»å…¥
  loginBtn.addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    try {
      await auth.signInWithEmailAndPassword(email, password);
      loginStatus.textContent = 'âœ… ç™»å…¥æˆåŠŸ';
    } catch (e) {
      loginStatus.textContent = 'ç™»å…¥å¤±æ•—: ' + e.message;
    }
  });

  // ç™»å‡º
  logoutBtn.addEventListener('click', () => auth.signOut());

  // ä¸Šå‚³è³‡æ–™
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const files = document.getElementById('imageFile').files;
    const model = document.getElementById('model').value;
    const year = document.getElementById('year').value;
    const mileage = document.getElementById('mileage').value;
    const condition = document.getElementById('condition').value;
    const note = document.getElementById('note').value;
    const bikeStatus = document.getElementById('status').value;

    if (!files.length) {
      alert('è«‹é¸æ“‡è‡³å°‘ä¸€å¼µåœ–ç‰‡');
      return;
    }

    try {
      statusText.textContent = 'åœ–ç‰‡ä¸Šå‚³ä¸­...';
      const uploadPromises = [];
      for (const file of files) {
        const imageRef = storage.ref('bikes/' + Date.now() + '_' + file.name);
        const uploadTask = imageRef.put(file).then(() => imageRef.getDownloadURL());
        uploadPromises.push(uploadTask);
      }
      const imageUrls = await Promise.all(uploadPromises);

      statusText.textContent = 'å„²å­˜è³‡æ–™ä¸­...';

      await firestore.collection('bikes').add({
        model,
        year: Number(year),
        mileage: Number(mileage),
        condition,
        note,
        status: bikeStatus,
        statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        imageUrls,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      statusText.textContent = 'âœ… ä¸Šå‚³æˆåŠŸï¼';
      form.reset();
      loadBikes();
    } catch (error) {
      console.error(error);
      statusText.textContent = 'ä¸Šå‚³å¤±æ•—: ' + error.message;
    }
  });

  // è¼‰å…¥è³‡æ–™
  async function loadBikes() {
    bikeGrid.innerHTML = '';
    const snapshot = await firestore.collection('bikes').orderBy('createdAt', 'desc').get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const id = doc.id;

      const imagesHtml = Array.isArray(data.imageUrls)
        ? data.imageUrls.map(url => `<img src="${url}" />`).join('')
        : '<p>æ²’æœ‰åœ–ç‰‡</p>';

      const card = document.createElement('div');
      card.className = 'bike-card';
      card.innerHTML = `
        <div class="image-slider">${imagesHtml}</div>
        <div class="bike-info" id="info-${id}">
          <p><strong>è»Šç¨®ï¼š</strong><span>${data.model}</span></p>
          <p><strong>å¹´ä»½ï¼š</strong><span>${data.year}</span></p>
          <p><strong>é‡Œç¨‹ï¼š</strong><span>${data.mileage}</span></p>
          <p><strong>è»Šæ³ï¼š</strong><span>${data.condition}</span></p>
          <p><strong>å‚™è¨»ï¼š</strong><span>${data.note || '-'}</span></p>
          <p><strong>ç‹€æ…‹ï¼š</strong><span class="status-badge ${data.status}">${data.status}</span></p>
          ${
            currentUser
              ? `<button class="editBtn" data-id="${id}">âœï¸ ç·¨è¼¯</button>`
              : ''
          }
        </div>
      `;
      bikeGrid.appendChild(card);
    });

    // ç¶å®šç·¨è¼¯æŒ‰éˆ•äº‹ä»¶
    document.querySelectorAll('.editBtn').forEach(btn => {
      btn.addEventListener('click', () => enableEditMode(btn.getAttribute('data-id')));
    });
  }

  // åˆ‡æ›æˆå¯ç·¨è¼¯æ¨¡å¼
  function enableEditMode(id) {
    const infoDiv = document.getElementById(`info-${id}`);
    const spans = infoDiv.querySelectorAll('span');
    const values = Array.from(spans).map(s => s.textContent);

    infoDiv.innerHTML = `
      <p><strong>è»Šç¨®ï¼š</strong><input id="edit-model-${id}" value="${values[0]}"></p>
      <p><strong>å¹´ä»½ï¼š</strong><input type="number" id="edit-year-${id}" value="${values[1]}"></p>
      <p><strong>é‡Œç¨‹ï¼š</strong><input type="number" id="edit-mileage-${id}" value="${values[2]}"></p>
      <p><strong>è»Šæ³ï¼š</strong><input id="edit-condition-${id}" value="${values[3]}"></p>
      <p><strong>å‚™è¨»ï¼š</strong><textarea id="edit-note-${id}">${values[4] !== '-' ? values[4] : ''}</textarea></p>
      <p><strong>ç‹€æ…‹ï¼š</strong>
        <select id="edit-status-${id}">
          <option value="è²©å”®ä¸­">è²©å”®ä¸­</option>
          <option value="å·²å”®å‡º">å·²å”®å‡º</option>
          <option value="æš«å”®">æš«å”®</option>
          <option value="ç¶­ä¿®ä¸­">ç¶­ä¿®ä¸­</option>
        </select>
      </p>
      <button class="saveBtn" data-id="${id}">ğŸ’¾ å„²å­˜</button>
      <button class="cancelBtn" data-id="${id}">âŒ å–æ¶ˆ</button>
    `;

    // è¨­å®šç‹€æ…‹åˆå§‹å€¼
    const statusSelect = document.getElementById(`edit-status-${id}`);
    statusSelect.value = infoDiv.querySelector('.status-badge')?.textContent || 'è²©å”®ä¸­';

    // ç¶å®šæŒ‰éˆ•
    infoDiv.querySelector('.saveBtn').addEventListener('click', async () => {
      await saveChanges(id);
    });
    infoDiv.querySelector('.cancelBtn').addEventListener('click', loadBikes);
  }

  // å„²å­˜ä¿®æ”¹
  async function saveChanges(id) {
    const model = document.getElementById(`edit-model-${id}`).value;
    const year = Number(document.getElementById(`edit-year-${id}`).value);
    const mileage = Number(document.getElementById(`edit-mileage-${id}`).value);
    const condition = document.getElementById(`edit-condition-${id}`).value;
    const note = document.getElementById(`edit-note-${id}`).value;
    const status = document.getElementById(`edit-status-${id}`).value;

    try {
      await firestore.collection('bikes').doc(id).update({
        model, year, mileage, condition, note, status,
        statusUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('âœ… å·²æ›´æ–°æˆåŠŸï¼');
      loadBikes();
    } catch (e) {
      alert('æ›´æ–°å¤±æ•—ï¼š' + e.message);
    }
  }

  window.onload = loadBikes;
</script>


</body>
</html>
